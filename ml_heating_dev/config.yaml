name: "ML Heating Control (Dev)"
version: "dev"
image: "ghcr.io/jhilkert90-wq/ml_heating"
slug: "ml_heating_dev"
description: "Physics-based machine learning heating control system with online learning (Development Channel)"
url: "https://github.com/jhilkert90-wq/ml_heating"
arch:
  - aarch64
  - amd64
startup: services
init: false
map:
  - addon_config:rw
ingress: true
ingress_port: 3001
panel_icon: mdi:heat-pump
panel_title: "ML Heating"
homeassistant: 2024.1.0
privileged:
  - SYS_RAWIO
apparmor: false
hassio_api: true
homeassistant_api: true
options:
  # Core Entity Configuration - Home Assistant Entity IDs
  # An input_number or sensor that holds the desired target indoor temperature
  target_indoor_temp_entity: "input_number.soll_rt"
  # The primary indoor temperature sensor that the system will try to maintain
  indoor_temp_entity: "sensor.current_rt"
  # The outdoor temperature sensor, preferably compensated or located near the heat pump
  outdoor_temp_entity: "sensor.nibe_bt1_outdoor_temperature"
  # The climate entity for your heating system, used to check if it's in 'heat' or 'auto' mode
  heating_control_entity: "sensor.betriebsmodus_wp"
  # The heat pump's actual outlet temperature sensor
  outlet_temp_entity: "sensor.nibe_bt2_supply_temp_s1"
  # The entity this script will write its calculated target outlet temperature to
  target_outlet_temp_entity: "input_number.ml_vorlauftemperatur"
  # The target outlet temperature that was actually set (by model or heat curve)
  actual_target_outlet_temp_entity: "sensor.nibe_calc_supply_s1"
  # An external weather forecast temperature sensor (e.g., from OpenWeatherMap)
  openweathermap_temp_entity: "weather.home"
  # A sensor that provides the average temperature of rooms not affected by the fireplace
  avg_other_rooms_temp_entity: "sensor.current_rt"
  # The Home Assistant sensor that provides today's PV forecast with attributes
  pv_forecast_entity: "sensor.ml_pv_forecast_watts"
  
  # External Heat Sources - Entity IDs for learning external heat contributions
  # A single aggregated sensor for total PV power generation
  pv_power_entity: "sensor.evcc_pv_power"
  # A binary_sensor that is 'on' when the fireplace is active
  fireplace_status_entity: "binary_sensor.kamin_an"
  # A sensor or input_boolean that indicates if a TV or other significant internal heat source is on
  tv_power_entity: "binary_sensor.bad_og_heizkorper"
  
  # Blocking Detection - Entity IDs for system status monitoring
  # A binary_sensor that is 'on' when Domestic Hot Water (DHW) is being heated
  dhw_status_entity: "binary_sensor.warmwassermodus"
  # A binary_sensor that is 'on' during a defrost cycle of the heat pump
  defrost_status_entity: "binary_sensor.defrost_wp"
  # A binary_sensor that is 'on' during a DHW tank disinfection cycle
  disinfection_status_entity: "binary_sensor.warmwassermodus"
  # A binary_sensor that is 'on' when the DHW boost heater is active
  dhw_boost_heater_entity: "binary_sensor.warmwassermodus"
  
  # ML Learning Parameters - Numeric configuration for model behavior
  # The time in minutes between each full cycle of learning and prediction
  cycle_interval_minutes: 30
  # The maximum allowable change (in degrees Celsius) for the heat pump's outlet temperature setpoint in a single cycle
  max_temp_change_per_cycle: 7.0
  # Number of historical steps to use as features for the model
  history_steps: 6
  # The duration of each historical step in minutes
  history_step_minutes: 10
  # The number of hours of historical data to use for initial training
  training_lookback_hours: 2000
  
  # Safety Configuration - Temperature limits and safety bounds
  # The maximum safe indoor temperature allowed by the system
  safety_max_temp: 25.0
  # The minimum safe indoor temperature allowed by the system
  safety_min_temp: 18.0
  # Absolute minimum allowed outlet temperature (in 째C)
  clamp_min_abs: 22.0
  # Absolute maximum allowed outlet temperature (in 째C)
  clamp_max_abs: 35.0
  
  # InfluxDB Configuration - Database connection settings
  # URL of your InfluxDB instance, including the protocol and port
  influxdb_host: "http://192.168.0.223:8089"
  # Port of your InfluxDB instance
  influxdb_port: 8089
  # The InfluxDB database where your Home Assistant data is stored
  influxdb_database: "home_assistant"
  # An InfluxDB API token with read access to the specified bucket
  influxdb_token: ""
  # The InfluxDB organization your Home Assistant data belongs to
  influxdb_org: "home"
  # The InfluxDB bucket where your Home Assistant data is stored
  influxdb_bucket: "home_assistant"
  # InfluxDB bucket for exporting feature importances and ML metrics
  influx_features_bucket: "ml_heating_features"
  
  auto_backup_enabled: true
  # Number of days to retain model backups
  backup_retention_days: 30
  # Dashboard Configuration - Web interface settings
  # Interval in seconds for dashboard data updates
  dashboard_update_interval: 30
  # Display advanced performance metrics on the dashboard
  show_advanced_metrics: true
  # Theme for the dashboard (auto, light, or dark)
  dashboard_theme: "auto"
  # Development Settings - Debug and development features (Enhanced for Alpha Channel)
  # Whether to enable the development API for external access (e.g., Jupyter notebooks)
  enable_dev_api: true
  # API key for authenticating with the development API
  dev_api_key: ""
  # The minimum level of log messages to display
  log_level: "DEBUG"
  # Performance Tuning - ML model optimization parameters
  # The model uses a normalized confidence in the range (0..1]. This threshold determines when the model's confidence is considered sufficient
  confidence_threshold: 0.3
  # Enable physics-based validation of model predictions
  physics_validation_enabled: true
  # Enable automatic seasonal learning using cosine/sine modulation
  seasonal_learning_enabled: true
  
  # Heat Balance Controller - Advanced trajectory-based control system
  # Enable the Heat Balance Controller (replaces exponential smoothing with 3-phase trajectory optimization)
  heat_balance_mode: true
  # Temperature error threshold for switching from CHARGING mode to BALANCING mode (in 째C)
  charging_mode_threshold: 0.5
  # Temperature error threshold for switching from BALANCING mode to MAINTENANCE mode (in 째C) 
  maintenance_mode_threshold: 0.2
  # Number of hours to predict in the thermal trajectory (2-8 hours)
  trajectory_steps: 4
  # Penalty weight for temperature oscillations in trajectory scoring (0.0-1.0)
  oscillation_penalty_weight: 0.3
  # Importance multiplier for the final temperature in trajectory scoring (1.0-3.0)
  final_destination_weight: 2.0
  # Advanced Learning Features - Multi-lag and seasonal learning
  # Enable time-delayed learning for external heat sources (PV, fireplace, TV)
  enable_multi_lag_learning: true
  # Number of lag steps for PV effects (each step = 30 minutes)
  pv_lag_steps: 4
  # Number of lag steps for fireplace effects
  fireplace_lag_steps: 4
  # Number of lag steps for TV effects
  tv_lag_steps: 2
  # Seasonal adaptation learning rate
  seasonal_learning_rate: 0.01
  # Minimum samples before seasonal learning starts
  min_seasonal_samples: 100
  # Enable learning from HVAC-off periods (typically summer)
  enable_summer_learning: true
  # System Behavior Configuration - Timing and polling settings
  # Maximum minutes to wait during grace period after blocking ends
  grace_period_max_minutes: 30
  # How often (seconds) to poll blocking entities during idle period
  blocking_poll_interval_seconds: 60
  # Prediction horizon steps for calibration
  prediction_horizon_steps: 48
  # Shadow Mode Configuration - Testing without affecting heating control
  # When enabled, ML runs in observation mode without affecting heating
  shadow_mode: false
  # Home Assistant input_boolean to enable/disable ML control dynamically
  # When ON: ML actively controls heating, When OFF: Shadow mode (ML observes only)
  ml_heating_control_entity: "input_boolean.ml_heating"
schema:
  # Core Entity Configuration - All entity fields as string input
  target_indoor_temp_entity: "str"
  indoor_temp_entity: "str"
  outdoor_temp_entity: "str"
  heating_control_entity: "str"
  outlet_temp_entity: "str"
  target_outlet_temp_entity: "str"
  actual_target_outlet_temp_entity: "str"
  openweathermap_temp_entity: "str"
  avg_other_rooms_temp_entity: "str"
  pv_forecast_entity: "str"
  # External Heat Sources - Entity fields as string input
  pv_power_entity: "str"
  fireplace_status_entity: "str"
  tv_power_entity: "str"
  # Blocking Detection - Entity fields as string input
  dhw_status_entity: "str"
  defrost_status_entity: "str"
  disinfection_status_entity: "str"
  dhw_boost_heater_entity: "str"
  # ML Learning Parameters - Numeric types with proper ranges
  cycle_interval_minutes: "int(5,60)"
  max_temp_change_per_cycle: "float(0.5,10.0)"
  history_steps: "int(3,12)"
  history_step_minutes: "int(5,30)"
  training_lookback_hours: "int(24,720)"
  # Safety Configuration - Float types with safety ranges
  safety_max_temp: "float(18.0,30.0)"
  safety_min_temp: "float(15.0,25.0)"
  clamp_min_abs: "float(10.0,25.0)"
  clamp_max_abs: "float(30.0,80.0)"
  # InfluxDB Configuration - String and port types
  influxdb_host: "str"
  influxdb_port: "port"
  influxdb_database: "str"
  influxdb_token: "str"
  influxdb_org: "str"
  influxdb_bucket: "str"
  influx_features_bucket: "str"
  # Model Management - Boolean and integer types
  auto_backup_enabled: "bool"
  backup_retention_days: "int(1,365)"
  # Dashboard Configuration - Integer, boolean, and list types
  dashboard_update_interval: "int(5,300)"
  show_advanced_metrics: "bool"
  dashboard_theme: "list(auto|light|dark)"
  # Development Settings - Boolean, string, and list types
  enable_dev_api: "bool"
  dev_api_key: "str"
  log_level: "list(DEBUG|INFO|WARNING|ERROR)"
  # Performance Tuning - Float and boolean types
  confidence_threshold: "float(0.1,0.95)"
  physics_validation_enabled: "bool"
  seasonal_learning_enabled: "bool"
  # Heat Balance Controller - Boolean, float, and integer types
  heat_balance_mode: "bool"
  charging_mode_threshold: "float(0.1,2.0)"
  maintenance_mode_threshold: "float(0.1,1.0)"
  trajectory_steps: "int(2,8)"
  oscillation_penalty_weight: "float(0.0,1.0)"
  final_destination_weight: "float(1.0,3.0)"
  # Advanced Learning Features - Boolean, integer, and float types
  enable_multi_lag_learning: "bool"
  pv_lag_steps: "int(1,8)"
  fireplace_lag_steps: "int(1,8)"
  tv_lag_steps: "int(1,6)"
  seasonal_learning_rate: "float(0.001,0.1)"
  min_seasonal_samples: "int(50,500)"
  enable_summer_learning: "bool"
  # System Behavior Configuration - Integer types
  grace_period_max_minutes: "int(10,120)"
  blocking_poll_interval_seconds: "int(30,300)"
  prediction_horizon_steps: "int(12,96)"
  # Shadow Mode Configuration - Boolean type
  shadow_mode: "bool"
  # ML Heating Control Entity - String type
  ml_heating_control_entity: "str"
