# ML Heating configuration Sample
# Copy this file to .env and set your actual values.
# Keep tokens and sensitive information secret; do NOT commit your .env file to version control.

# --- Home Assistant ---
# Base URL of your Home Assistant instance (e.g., http://homeassistant.local:8123)
HASS_URL=https://home-assistant.example.com

# A Long-Lived Access Token from your Home Assistant profile page.
HASS_TOKEN=YOUR_HOME_ASSISTANT_TOKEN

# --- InfluxDB ---
# URL of your InfluxDB instance, including the protocol and port.
INFLUX_URL=https://influxdb.example.com:8086

# An InfluxDB API token with read access to the specified bucket.
INFLUX_TOKEN=YOUR_INFLUXDB_TOKEN

# The InfluxDB organization and bucket where your Home Assistant data is stored.
INFLUX_ORG=your-org
INFLUX_BUCKET=home_assistant/autogen

# --- Model and State ---
# Absolute path to store the trained machine learning model file.
MODEL_FILE=/opt/ml_heating/ml_model.pkl

# Absolute path to store the last state (features) for online learning.
STATE_FILE=/opt/ml_heating/ml_state.pkl

# --- Script Behavior ---
# Number of historical steps to use as features for the model.
HISTORY_STEPS=6

# The duration of each historical step in minutes.
HISTORY_STEP_MINUTES=10

# How many 5-minute steps into the future the model should predict.
# Example: 24 means 24 * 5min = 120 minutes ahead.
PREDICTION_HORIZON_STEPS=24

# The number of hours of historical data to use for initial training.
TRAINING_LOOKBACK_HOURS=168

# --- Home Assistant Entity IDs ---
# These must match the entity IDs in your Home Assistant instance.

# An input_number or sensor that holds the target indoor temperature.
TARGET_INDOOR_TEMP_ENTITY_ID=input_number.hp_auto_correct_target

# The primary indoor temperature sensor.
INDOOR_TEMP_ENTITY_ID=sensor.your_indoor_temp_sensor

# The heat pump's outlet temperature sensor.
ACTUAL_OUTLET_TEMP_ENTITY_ID=sensor.your_hp_outlet_temp

# The entity this script will write its calculated target outlet temperature to.
TARGET_OUTLET_TEMP_ENTITY_ID=sensor.ml_vorlauftemperatur

# The target outlet temperature that was actually set (by model or heat curve).
# Used for learning in both active and shadow modes. This allows the model to
# learn correctly even when running in shadow mode (not controlling the heating).
ACTUAL_TARGET_OUTLET_TEMP_ENTITY_ID=sensor.hp_target_temp_circuit1

# A binary sensor that is 'on' when Domestic Hot Water (DHW) is being heated.
DHW_STATUS_ENTITY_ID=binary_sensor.your_dhw_status_sensor

# A binary sensor that is 'on' during a defrost cycle.
DEFROST_STATUS_ENTITY_ID=binary_sensor.hp_defrosting_status

# A binary sensor that is 'on' during a DHW tank disinfection cycle.
DISINFECTION_STATUS_ENTITY_ID=binary_sensor.hp_dhw_tank_disinfection_status

# A binary sensor that is 'on' when the DHW boost heater is active.
DHW_BOOST_HEATER_STATUS_ENTITY_ID=binary_sensor.hp_dhw_boost_heater_status

# A sensor or helper (e.g., input_boolean) that indicates if a TV or other significant heat source is on.
TV_STATUS_ENTITY_ID=input_boolean.your_tv_status

# A binary sensor that is 'on' when the fireplace is active.
FIREPLACE_STATUS_ENTITY_ID=binary_sensor.your_fireplace_status

# A sensor that provides the average temperature of rooms not affected by the fireplace.
AVG_OTHER_ROOMS_TEMP_ENTITY_ID=sensor.your_avg_other_rooms_temp

# The outdoor temperature sensor, preferably compensated or near the heat pump.
OUTDOOR_TEMP_ENTITY_ID=sensor.your_outdoor_temp_sensor

# The climate entity for your heating system, used to check if it's in 'heat' or 'auto' mode.
HEATING_STATUS_ENTITY_ID=climate.your_heating_entity

# An external weather forecast temperature sensor (e.g., from OpenWeatherMap).
OPENWEATHERMAP_TEMP_ENTITY_ID=sensor.openweathermap_temperature

# --- PV (Solar) Power Entity ID ---
# A single aggregated sensor for total PV power generation.
PV_POWER_ENTITY_ID=sensor.power_pv

# The Home Assistant sensor that provides today's PV forecast with attributes
# 'watts' (15-min samples) used to compute hourly forecast means.
PV_FORECAST_ENTITY_ID=sensor.energy_production_today_4

# --- Debugging ---
# Set to "1" to enable detailed logging of feature vectors and model decisions.
# Set to "0" or remove for normal operation.
DEBUG=0

# --- Model Confidence ---
# The physics model uses learning_confidence in range (0.1..10.0], where higher values mean
# better learning performance and parameter stability. The system falls back to traditional
# heat curve when confidence drops below threshold.
# Current scale: 0.1=poor, 2.0=fair, 3.0=good, 4.0=excellent, 5.0+=outstanding
# Recommended: 2.0 for safety fallback while allowing ML to operate normally
CONFIDENCE_THRESHOLD=2.0

# --- Trajectory Prediction ---
# Number of hours to predict in trajectory optimization.
TRAJECTORY_STEPS=4

# The time in minutes between each full cycle of learning and prediction.
CYCLE_INTERVAL_MINUTES=10

# The maximum allowable integer change (in degrees) for the outlet temperature
# setpoint in a single cycle. This prevents abrupt changes and is required as
# the heatpump may only accept full degrees.
MAX_TEMP_CHANGE_PER_CYCLE=2

# InfluxDB bucket for exporting feature importances
INFLUX_FEATURES_BUCKET=ml_heating_features

# Maximum minutes to wait during the grace period after blocking ends.
GRACE_PERIOD_MAX_MINUTES=30

# How often (seconds) to poll blocking entities during the idle period.
# A value of 60 means we check the blocking state once per minute. Increase
# this value to reduce HA polling load, or lower it to react faster to
# defrost/DHW transitions.
BLOCKING_POLL_INTERVAL_SECONDS=60

# --- Absolute clamp settings for ML-proposed outlet temp ---
# Override these in your .env to change the allowed ML output range.
# Any ML-proposed temp will be clipped to [CLAMP_MIN_ABS, CLAMP_MAX_ABS].
CLAMP_MIN_ABS=14.0
CLAMP_MAX_ABS=65.0

# --- Optional: Model Metrics Entity IDs ---
# These entities are automatically created in Home Assistant for monitoring.
# You can override the defaults if needed.
# CONFIDENCE_ENTITY_ID=sensor.ml_model_confidence
# MAE_ENTITY_ID=sensor.ml_model_mae
# RMSE_ENTITY_ID=sensor.ml_model_rmse

# --- Multi-Lag External Source Learning ---
# Enable time-delayed learning for PV, fireplace, and TV.
# When enabled, the model learns how these heat sources affect indoor
# temperature with delays (e.g., PV warming peaks 60-90min after production).
ENABLE_MULTI_LAG_LEARNING=true

# Number of lag steps (30min each) to track for each source:
# - PV: 4 lags = track 30, 60, 90, 120min delays
# - Fireplace: 4 lags = immediate, 30, 60, 90min
# - TV: 2 lags = immediate, 30min
PV_LAG_STEPS=4
FIREPLACE_LAG_STEPS=4
TV_LAG_STEPS=2

# --- Seasonal Adaptation ---
# Enable automatic seasonal learning using cos/sin modulation.
# This eliminates the need for manual recalibration between winter and summer.
# The model learns how external sources vary seasonally (e.g., windows open
# in summer reduce PV warming effect by ~50%).
ENABLE_SEASONAL_ADAPTATION=true

# Learning rate for seasonal parameters (lower = more stable, slower adapt)
SEASONAL_LEARNING_RATE=0.01

# Minimum samples before seasonal learning starts
MIN_SEASONAL_SAMPLES=100

# --- Summer Learning ---
# Enable learning from periods when HVAC is off (typically summer).
# This provides cleaner signal for external source effects without
# heating interference. Improves PV and TV coefficients significantly.
ENABLE_SUMMER_LEARNING=true

# --- Shadow Mode ---
# Set to "true" to run ML in observation mode without affecting heating control.
# When enabled: 
# - ML calculates predictions but does not update target temperature
# - No HA sensors are updated (confidence, MAE, RMSE, state)
# - System learns from heat curve's actual control decisions
# - Performance comparison logging between ML vs heat curve
# When disabled: ML actively controls heating system (normal mode)
SHADOW_MODE=false

# --- ML Heating Control Entity ---
# Home Assistant input_boolean to enable/disable ML control dynamically.
# - When ON: ML actively controls heating (Active Mode)
# - When OFF: Shadow mode activated (ML observes only)
# - Note: SHADOW_MODE environment variable overrides this setting
# Create in HA with: input_boolean.ml_heating
ML_HEATING_CONTROL_ENTITY_ID=input_boolean.ml_heating

# --- Thermal Equilibrium Model Parameters ---
# Core thermal physics parameters for the thermal equilibrium model.
# These parameters control the physics-based calculations and can be tuned
# for different building characteristics and testing scenarios.

# Core Thermal Properties (Priority 1 - Critical for Model Behavior)
THERMAL_TIME_CONSTANT=4.0          # Building thermal response time (hours)
HEAT_LOSS_COEFFICIENT=0.2         # Heat loss rate per degree difference
OUTLET_EFFECTIVENESS=0.04          # Heat pump outlet efficiency
OUTDOOR_COUPLING=0.3                # Outdoor temperature influence factor
THERMAL_BRIDGE_FACTOR=0.1           # Thermal bridging losses

# External Heat Source Weights (Priority 2 - Multi-Source Testing)
# Only includes heat sources with actual sensors in your system
PV_HEAT_WEIGHT=0.002                # 2°C per kW solar heating
FIREPLACE_HEAT_WEIGHT=5.0          # 5°C direct contribution
TV_HEAT_WEIGHT=0.2                # 0.2°C electronics heating

# Adaptive Learning Parameters (Priority 3 - Advanced Tuning)
ADAPTIVE_LEARNING_RATE=0.05         # Base learning rate
MIN_LEARNING_RATE=0.01              # Minimum learning rate
MAX_LEARNING_RATE=0.2               # Maximum learning rate
LEARNING_CONFIDENCE=3.0             # Initial learning confidence
RECENT_ERRORS_WINDOW=10             # Error analysis window size

# --- Hybrid Learning Strategy (Phase 2 Enhancement) ---
# Enable intelligent learning phase classification with weighted periods
HYBRID_LEARNING_ENABLED=true
STABILITY_CLASSIFICATION_ENABLED=true
HIGH_CONFIDENCE_WEIGHT=1.0          # Weight for stable periods (high confidence learning)
LOW_CONFIDENCE_WEIGHT=0.3           # Weight for controlled transitions (low confidence learning)
LEARNING_PHASE_SKIP_WEIGHT=0.0      # Weight for chaotic periods (skip learning)

# --- MAE/RMSE Tracking System (Phase 2 Enhancement) ---
# Enable comprehensive prediction accuracy tracking
PREDICTION_METRICS_ENABLED=true
METRICS_WINDOW_1H=12                # 1 hour window (12 x 5min samples)
METRICS_WINDOW_6H=72                # 6 hour window (72 x 5min samples)
METRICS_WINDOW_24H=288              # 24 hour window (288 x 5min samples)
PREDICTION_ACCURACY_THRESHOLD=0.3   # °C threshold for accuracy classification

# --- Trajectory Prediction Enhancement (Phase 2) ---
# Advanced trajectory prediction with forecast integration
TRAJECTORY_PREDICTION_ENABLED=true
WEATHER_FORECAST_INTEGRATION=true   # Use weather forecasts in trajectory prediction
PV_FORECAST_INTEGRATION=true        # Use PV forecasts in trajectory prediction
OVERSHOOT_DETECTION_ENABLED=true    # Enable trajectory-based overshoot detection

# --- Historical Calibration System (Phase 0) ---
# Physics-based historical parameter optimization
CALIBRATION_BASELINE_FILE=/data/calibrated_baseline.json
STABILITY_TEMP_CHANGE_THRESHOLD=0.1 # °C change threshold for stability filtering
MIN_STABLE_PERIOD_MINUTES=30        # Minimum duration for stable periods
OPTIMIZATION_METHOD=L-BFGS-B        # Scipy optimization method

# --- Delta Temperature Forecast Calibration ---
# Local weather forecast calibration using temperature offset
ENABLE_DELTA_FORECAST_CALIBRATION=true # Enable delta calibration using local temperature offset
DELTA_CALIBRATION_MAX_OFFSET=10.0      # Maximum allowed offset (°C) for safety
